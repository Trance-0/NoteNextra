    # Example for conf.d/default.conf
user www-data;
worker_processes 1;

error_log /var/log/nginx/error.log;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {

    upstream notenextra-math {
        server notenextra-math:4200;
    }

    upstream notenextra-cse {
        server notenextra-cse:4200;
    }

    # Decide where to send /_pagefind* based on the page that made the request
    map $http_referer $load_upstream {
        default                          http://notenextra-cse;
        ~*://[^/]+/Math(?:/|$)           http://notenextra-math;
        ~*://[^/]+/CSE(?:/|$)            http://notenextra-cse;
    }


    include       /etc/nginx/mime.types;

    # add extra types

    types {
        text/javascript mjs;
    }

    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    server {
        listen 80;
        server_name localhost;

        rewrite ^/.well-known/carddav /remote.php/dav/ permanent;
        rewrite ^/.well-known/caldav /remote.php/dav/ permanent;

        location = /robots.txt {
            allow all;
            log_not_found off;
            access_log off;
        }

        # Send all next or additional assets (/_pagefind.js and /_pagefind/*) to the chosen app
        # ^~ /_pagefind matches both "/_pagefind.js" and "/_pagefind/..."
        location ^~ /_(.*)$ {
            proxy_pass $load_upstream;   # leaves URI intact (/_pagefind.js, /_pagefind/manifest.json, etc.)
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location ~ ^/(build|tests|config|lib|3rdparty|templates|data)/ {
            deny all;
        }

        location ~ ^/(?:\.|autotest|occ|issue|indie|db_|console) {
            deny all;
        }

        # Course-specific prefix
        location ^~ /Math3200/ {
            proxy_pass https://notenextra-math3200.pages.dev;
            proxy_set_header Host notenextra-math3200.pages.dev;

            proxy_ssl_server_name on;
            proxy_ssl_name notenextra-math3200.pages.dev;

            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        location ^~ /Math429/ {
            proxy_pass https://notenextra-math429.pages.dev;
            proxy_set_header Host notenextra-math429.pages.dev;

            proxy_ssl_server_name on;
            proxy_ssl_name notenextra-math429.pages.dev;

            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        location ^~ /Math4111/ {
            proxy_pass https://notenextra-math4111.pages.dev;
            proxy_set_header Host notenextra-math4111.pages.dev;

            proxy_ssl_server_name on;
            proxy_ssl_name notenextra-math4111.pages.dev;

            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        location ^~ /Math4121/ {
            proxy_pass https://notenextra-math4121.pages.dev;
            proxy_set_header Host notenextra-math4121.pages.dev;

            proxy_ssl_server_name on;
            proxy_ssl_name notenextra-math4121.pages.dev;

            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        location ^~ /Math4201/ {
            proxy_pass https://notenextra-math4201.pages.dev;
            proxy_set_header Host notenextra-math4201.pages.dev;

            proxy_ssl_server_name on;
            proxy_ssl_name notenextra-math4201.pages.dev;

            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        location ^~ /Math4202/ {
            proxy_pass https://notenextra-math4202.pages.dev;
            proxy_set_header Host notenextra-math4202.pages.dev;

            proxy_ssl_server_name on;
            proxy_ssl_name notenextra-math4202.pages.dev;

            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        location ^~ /Math4302/ {
            proxy_pass https://notenextra-math4302.pages.dev;
            proxy_set_header Host notenextra-math4302.pages.dev;

            proxy_ssl_server_name on;
            proxy_ssl_name notenextra-math4302.pages.dev;

            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }


        location ^~ /Math416/ {
            proxy_pass https://notenextra-math416.pages.dev;
            proxy_set_header Host notenextra-math416.pages.dev;

            proxy_ssl_server_name on;
            proxy_ssl_name notenextra-math416.pages.dev;

            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        location ^~ /Math401/ {
            proxy_pass https://notenextra-math401.pages.dev;
            proxy_set_header Host notenextra-math401.pages.dev;

            proxy_ssl_server_name on;
            proxy_ssl_name notenextra-math401.pages.dev;

            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        location ^~ /CSE332S/ {
            proxy_pass https://notenextra-cse332s.pages.dev;
            proxy_set_header Host notenextra-cse332s.pages.dev;

            proxy_ssl_server_name on;
            proxy_ssl_name notenextra-cse332s.pages.dev;

            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        location ^~ /CSE347/ {
            proxy_pass https://notenextra-cse347.pages.dev;
            proxy_set_header Host notenextra-cse347.pages.dev;

            proxy_ssl_server_name on;
            proxy_ssl_name notenextra-cse347.pages.dev;

            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        location ^~ /CSE442T/ {
            proxy_pass https://notenextra-cse442t.pages.dev;
            proxy_set_header Host notenextra-cse442t.pages.dev;

            proxy_ssl_server_name on;
            proxy_ssl_name notenextra-cse442t.pages.dev;

            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        location ^~ /CSE5313/ {
            proxy_pass https://notenextra-cse5313.pages.dev;
            proxy_set_header Host notenextra-cse5313.pages.dev;

            proxy_ssl_server_name on;
            proxy_ssl_name notenextra-cse5313.pages.dev;

            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        location ^~ /CSE510/ {
            proxy_pass https://notenextra-cse510.pages.dev;
            proxy_set_header Host notenextra-cse510.pages.dev;

            proxy_ssl_server_name on;
            proxy_ssl_name notenextra-cse510.pages.dev;

            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        location ^~ /CSE559A/ {
            proxy_pass https://notenextra-cse559a.pages.dev;
            proxy_set_header Host notenextra-cse559a.pages.dev;

            proxy_ssl_server_name on;
            proxy_ssl_name notenextra-cse559a.pages.dev;

            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        location ^~ /CSE4303/ {
            proxy_pass https://notenextra-cse4303.pages.dev;
            proxy_set_header Host notenextra-cse4303.pages.dev;

            proxy_ssl_server_name on;
            proxy_ssl_name notenextra-cse4303.pages.dev;

            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        location ^~ /CSE5519/ {
            proxy_pass https://notenextra-cse5519.pages.dev;
            proxy_set_header Host notenextra-cse5519.pages.dev;

            proxy_ssl_server_name on;
            proxy_ssl_name notenextra-cse5519.pages.dev;

            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Everything else
        location / {
            proxy_pass https://notenextra-cse332s.pages.dev;
            proxy_set_header Host notenextra-cse332s.pages.dev;

            proxy_ssl_server_name on;
            proxy_ssl_name notenextra-cse332s.pages.dev;

            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        access_log  /www/wwwlogs/test.trance-0.com.log;
        error_log  /www/wwwlogs/test.trance-0.com.error.log;
    }
}